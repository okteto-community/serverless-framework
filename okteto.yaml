build:
  serverless:
    context: tools

deploy:
  image: $OKTETO_BUILD_SERVERLESS_IMAGE
  commands:
    - name: Deploy your serverless function
      command: |
        set -e
        cd function
        serverless deploy
        
        # get the Deployed Name, ARN and URL of the function 
        HELLO_DEPLOYED_NAME=$(serverless info --json | jq -r '.info.functions[] | select(.name == "hello") | .deployedName')
        HELLO_ARN=$(serverless info --json | jq -r '.outputs[] | select(.OutputKey == "HelloLambdaFunctionQualifiedArn") | .OutputValue')
        HELLO_URL="https://${AWS_REGION}.console.aws.amazon.com/lambda/home?region=${AWS_REGION}#/functions/${HELLO_DEPLOYED_NAME}?tab=code"
        
        # Pass the values to the OKTETO_ENV so they are included in the UI
        echo "OKTETO_EXTERNAL_SERVERLESS_ENDPOINTS_ARN_URL=$HELLO_ARN" >> $OKTETO_ENV
        echo "OKTETO_EXTERNAL_SERVERLESS_ENDPOINTS_WEB_URL=$HELLO_URL" >> $OKTETO_ENV

test:
  serverless:
    image: $OKTETO_BUILD_SERVERLESS_IMAGE
    context: function
    commands:
    - name: test the function
      command: |
        serverless info --json | jq -r '.info.functions[] | select(.name == "hello") | .deployedName'
        serverless invoke --function hello

destroy:
  image: $OKTETO_BUILD_SERVERLESS_IMAGE
  commands:
    - name: Delete your serverless function
      command: |
        set -e
        cd function
        serverless remove

external:
  serverless:
    icon: function
    endpoints:
      - name: arn
      - name: web
